name: Deploy Cloudflare Tunnel

on:
  workflow_dispatch:
  push:
    paths:
      - 'cloudflared/**'
      - '.github/workflows/deploy-cloudflared.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare credentials file from secret
        env:
          CF_TUNNEL_JSON: ${{ secrets.CF_TUNNEL_JSON }}
        run: |
          if [ -z "${CF_TUNNEL_JSON}" ]; then
            echo "CF_TUNNEL_JSON secret is empty"; exit 1
          fi
          echo "$CF_TUNNEL_JSON" | base64 --decode > ./tunnel-credentials.json

      - name: Copy credentials and config to server
        uses: appleboy/scp-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "./tunnel-credentials.json,cloudflared/config.yml"
          target: "/tmp/cloudflared-deploy"

      - name: Deploy on server (move files, set perms, restart)
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            sudo mkdir -p /etc/cloudflared
            sudo mv /tmp/cloudflared-deploy/tunnel-credentials.json /etc/cloudflared/<TUNNEL-UUID>.json
            sudo mv /tmp/cloudflared-deploy/config.yml /etc/cloudflared/config.yml
            sudo chown root:root /etc/cloudflared/<TUNNEL-UUID>.json /etc/cloudflared/config.yml
            sudo systemctl daemon-reload || true
            sudo systemctl enable --now cloudflared || sudo systemctl restart cloudflared || true
            sudo systemctl status cloudflared --no-pager || true
